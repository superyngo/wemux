name: MSIX Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.3.0)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build-msix:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-msvc

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        key: msix-release

    - name: Extract version from tag or input
      id: version
      shell: pwsh
      run: |
        if ("${{ github.event.inputs.version }}" -ne "") {
          $version = "${{ github.event.inputs.version }}"
          Write-Host "Using workflow input version: $version"
        } elseif ("${{ github.ref_name }}" -match "^v(.+)$") {
          $version = $matches[1]
          Write-Host "Using tag version: $version"
        } else {
          # Fallback to Cargo.toml
          $cargoToml = Get-Content "Cargo.toml"
          $versionMatch = $cargoToml | Select-String 'version\s*=\s*"([^"]+)"' | Select-Object -First 1
          $version = $versionMatch.Matches[0].Groups[1].Value
          Write-Host "Using Cargo.toml version: $version"
        }

        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "VERSION_QUAD=$version.0" >> $env:GITHUB_OUTPUT

        Write-Host "Final version: $version"

    - name: Install ImageMagick
      shell: pwsh
      run: |
        Write-Host "Installing ImageMagick via winget..."
        winget install ImageMagick.ImageMagick --silent --accept-source-agreements --accept-package-agreements

        # Add ImageMagick to PATH for this session
        $env:PATH += ";C:\Program Files\ImageMagick-7.1.1-Q16-HDRI"
        echo "C:\Program Files\ImageMagick-7.1.1-Q16-HDRI" >> $env:GITHUB_PATH

    - name: Generate icon assets
      shell: pwsh
      run: |
        Write-Host "Generating MSIX icon assets..."
        .\scripts\generate_icons.ps1

        # Verify icons were created
        $iconCount = (Get-ChildItem -Path "packaging\assets" -Filter "*.png").Count
        Write-Host "Generated $iconCount icon files"

        if ($iconCount -lt 7) {
          Write-Host "Error: Expected at least 7 icons, found $iconCount"
          exit 1
        }

    - name: Build release
      shell: pwsh
      run: |
        Write-Host "Building wemux release..."
        cargo build --release

        # Verify executable was created
        if (-not (Test-Path "target\release\wemux.exe")) {
          Write-Host "Error: wemux.exe not found after build"
          exit 1
        }

        $exeSize = [math]::Round((Get-Item "target\release\wemux.exe").Length / 1MB, 2)
        Write-Host "Built wemux.exe ($exeSize MB)"

    - name: Setup packaging directory
      shell: pwsh
      run: |
        Write-Host "Setting up packaging staging directory..."
        New-Item -ItemType Directory -Force -Path "packaging\staging" | Out-Null
        New-Item -ItemType Directory -Force -Path "packaging\staging\assets" | Out-Null
        New-Item -ItemType Directory -Force -Path "packaging\output" | Out-Null

    - name: Copy files to staging
      shell: pwsh
      run: |
        Write-Host "Copying files to staging..."

        # Copy executable
        Copy-Item "target\release\wemux.exe" "packaging\staging\"

        # Copy tray icons (if they exist)
        if (Test-Path "assets\icons\tray") {
          Copy-Item "assets\icons\tray\*.png" "packaging\staging\assets\" -ErrorAction SilentlyContinue
        }

        # Copy MSIX-specific icons
        Copy-Item "packaging\assets\*.png" "packaging\staging\assets\" -Force

        $fileCount = (Get-ChildItem -Path "packaging\staging" -Recurse -File).Count
        Write-Host "Copied $fileCount files to staging"

    - name: Update manifest version and identity
      shell: pwsh
      run: |
        Write-Host "Updating AppxManifest.xml..."

        $version = "${{ steps.version.outputs.VERSION_QUAD }}"
        $manifest = Get-Content "packaging\AppxManifest.xml" -Raw

        # Update version
        $manifest = $manifest -replace 'Version="[\d\.]+"', "Version=`"$version`""

        # Check if manifest still has placeholder values
        if ($manifest -match "PLACEHOLDER") {
          Write-Host ""
          Write-Host "‚ö† WARNING: AppxManifest.xml contains PLACEHOLDER values!" -ForegroundColor Yellow
          Write-Host "Please update packaging/AppxManifest.xml with your Microsoft Partner Center identity:" -ForegroundColor Yellow
          Write-Host "  1. Go to https://partner.microsoft.com/dashboard" -ForegroundColor White
          Write-Host "  2. Navigate to your wemux app ‚Üí Product Identity" -ForegroundColor White
          Write-Host "  3. Replace PLACEHOLDER values in AppxManifest.xml" -ForegroundColor White
          Write-Host ""
          Write-Host "Continuing with PLACEHOLDER values for now (package will need manual update)..." -ForegroundColor Yellow
          Write-Host ""
        }

        Set-Content "packaging\staging\AppxManifest.xml" -Value $manifest -Encoding UTF8
        Write-Host "Manifest version set to: $version"

    - name: Create MSIX package
      shell: pwsh
      run: |
        Write-Host "Creating MSIX package..."

        $version = "${{ steps.version.outputs.VERSION }}"
        $msixPath = "packaging\output\wemux_${version}_x64.msix"

        & makeappx.exe pack /d "packaging\staging" /p $msixPath /o

        if ($LASTEXITCODE -ne 0) {
          Write-Host "Error: makeappx.exe failed with exit code $LASTEXITCODE"
          exit 1
        }

        $msixSize = [math]::Round((Get-Item $msixPath).Length / 1MB, 2)
        Write-Host "MSIX package created: $msixPath ($msixSize MB)"

        # Validate package
        Write-Host "Validating MSIX package..."
        & makeappx.exe validate /p $msixPath

        # Move to root for easier upload
        Move-Item $msixPath "wemux_${version}_x64.msix" -Force

        # Set output for release step
        echo "MSIX_PATH=wemux_${version}_x64.msix" >> $env:GITHUB_OUTPUT
        echo "MSIX_SIZE=$msixSize" >> $env:GITHUB_OUTPUT

    - name: Create release notes
      id: release_notes
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"

        $notes = @"
        ## wemux v$version - MSIX Package

        ### üì¶ Downloads

        **MSIX Package (Microsoft Store format):**
        - ``wemux_${version}_x64.msix`` - Windows 10/11 x64

        ### üìù Installation Methods

        #### Method 1: Microsoft Store (Recommended)
        - This package can be submitted to Microsoft Store for automatic updates
        - Users can install directly from the Store once published

        #### Method 2: Direct Installation

        **Prerequisites:**
        - Windows 10 version 1809 (build 17763) or later
        - Windows 11 (all versions)

        **Steps:**
        1. Download ``wemux_${version}_x64.msix``
        2. Enable Developer Mode in Windows Settings (Settings ‚Üí Privacy & Security ‚Üí For developers)
        3. Double-click the MSIX file to install

        **Or install via PowerShell:**
        ``````powershell
        Add-AppxPackage -Path wemux_${version}_x64.msix
        ``````

        #### Method 3: WinGet (Coming Soon)
        ``````
        winget install wemux
        ``````

        ### ‚ú® Features

        - System tray application for easy control
        - Real-time audio duplication to multiple HDMI devices
        - Automatic device detection and hot-plug support
        - Persistent device preferences
        - Low-latency synchronization

        ### üîí Privacy

        wemux is privacy-first and does not collect any data:
        - No telemetry or analytics
        - No internet connection required
        - All processing happens locally
        - See [PRIVACY.md](https://github.com/superyngo/wemux/blob/main/PRIVACY.md) for details

        ### üìã System Requirements

        - **OS:** Windows 10 (1809+) or Windows 11
        - **Architecture:** x64 (64-bit)
        - **Audio:** WASAPI-compatible audio devices
        - **HDMI:** At least one HDMI audio output device

        ### üêõ Known Issues

        - None reported for this version

        ### üîÑ Updates

        - **Microsoft Store:** Automatic updates
        - **Sideload:** Check GitHub releases for new versions

        ### üÜò Support

        - Report issues: https://github.com/superyngo/wemux/issues
        - View source code: https://github.com/superyngo/wemux

        ---

        **Built with ‚ù§Ô∏è using Rust and Windows Audio API**
        "@

        # Save to file for upload
        Set-Content -Path "release_notes.md" -Value $notes

        # Also output for GitHub release
        echo "NOTES<<EOF" >> $env:GITHUB_OUTPUT
        echo $notes >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT

    - name: Upload MSIX to release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          wemux_${{ steps.version.outputs.VERSION }}_x64.msix
          release_notes.md
        body: ${{ steps.release_notes.outputs.NOTES }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload MSIX as artifact (for workflow_dispatch)
      uses: actions/upload-artifact@v4
      if: github.event_name == 'workflow_dispatch'
      with:
        name: wemux-msix-${{ steps.version.outputs.VERSION }}
        path: wemux_${{ steps.version.outputs.VERSION }}_x64.msix
        retention-days: 30

    - name: Build summary
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"

        Write-Host ""
        Write-Host "=== Build Summary ===" -ForegroundColor Green
        Write-Host "Version: $version" -ForegroundColor Cyan
        Write-Host "Package: wemux_${version}_x64.msix" -ForegroundColor Cyan
        Write-Host "Size: ${{ steps.create_msix.outputs.MSIX_SIZE }} MB" -ForegroundColor Cyan

        if ("${{ github.ref_type }}" -eq "tag") {
          Write-Host "Release: Created at https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" -ForegroundColor Green
        } else {
          Write-Host "Artifact: Available in workflow artifacts" -ForegroundColor Yellow
        }

        Write-Host ""
        Write-Host "Next steps for Microsoft Store submission:" -ForegroundColor Yellow
        Write-Host "  1. Go to https://partner.microsoft.com/dashboard" -ForegroundColor White
        Write-Host "  2. Update AppxManifest.xml with your app identity (if not done)" -ForegroundColor White
        Write-Host "  3. Upload wemux_${version}_x64.msix to Partner Center" -ForegroundColor White
        Write-Host "  4. Complete Store listing with screenshots and description" -ForegroundColor White
        Write-Host "  5. Submit for certification" -ForegroundColor White
        Write-Host ""
